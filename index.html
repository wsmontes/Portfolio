<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Portfolio Network</title>
    <meta name="description" content="Interactive 3D portfolio showcasing software development, IT skills, media work, and photography">
    
    <!-- Preconnect hints for faster loading -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://d3js.org">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/repository.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <style>
        .navbar {
            background-color: transparent !important;
        }
    </style>
</head>
<body>
    <div class="overlay">
        <div class="loading-screen">
            <div class="spinner"></div>
            <p>Building network...</p>
        </div>
        
        <nav class="navbar">
            <div class="logo">
                <a href="#" id="resetView">Portfolio</a>
            </div>
            <button class="menu-toggle" aria-label="Toggle Menu">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-menu">
                <!-- Menu items will be populated dynamically -->
            </ul>
        </nav>
        
        <div id="graph-container"></div>
        
        <!-- Add the React root element -->
        <div id="root"></div>
        
        <div id="content-panel" class="hidden">
            <button class="close-panel" aria-label="Close panel"><i class="fas fa-times"></i></button>
            <div class="content-inner">
                <!-- Content will be loaded here dynamically -->
            </div>
        </div>
        
        <div class="controls">
            <button id="zoom-in" title="Zoom In"><i class="fas fa-plus"></i></button>
            <button id="zoom-out" title="Zoom Out"><i class="fas fa-minus"></i></button>
            <button id="reset-camera" title="Reset View"><i class="fas fa-home"></i></button>
        </div>
    </div>
    
    <!-- Structured script loading for better dependency management -->
    <!-- 1. Define global THREE variable to avoid duplicate instances -->
    <script>
        // Ensure we only have one THREE instance
        window.THREE = window.THREE || {};
        
        // Flag to indicate we're handling THREE globally
        window.GLOBAL_THREE_HANDLED = true;
    </script>
    
    <!-- 2. Load THREE.js library -->
    <script src="https://unpkg.com/three@0.149.0/build/three.min.js"></script>
    
    <!-- 3. Initialize THREE.js and make it globally available -->
    <script src="assets/js/three-init.js"></script>
    
    <!-- 4. Fix for 3D-force-graph to use our THREE instance -->
    <script>
        // Store original THREE instance before 3D-force-graph loads
        window.originalTHREE = window.THREE;
        
        // Improved function to restore our THREE instance if overwritten
        function ensureGlobalTHREE() {
            if (window.THREE !== window.originalTHREE) {
                console.log('Restoring global THREE instance');
                const newFeatures = Object.keys(window.THREE).filter(
                    key => !window.originalTHREE[key]
                );
                
                // Copy any new features to our original THREE
                newFeatures.forEach(feature => {
                    window.originalTHREE[feature] = window.THREE[feature];
                });
                
                // Restore our original THREE
                window.THREE = window.originalTHREE;
                
                // Add console info to help debugging
                console.info('THREE.js instance has been unified. The warning about multiple instances can be ignored.');
            }
        }
        
        // Run immediately and also after scripts load
        ensureGlobalTHREE();
        window.addEventListener('load', ensureGlobalTHREE);
    </script>
    
    <!-- 5. Load d3-force for the collision detection -->
    <script src="https://d3js.org/d3-dispatch.v2.min.js"></script>
    <script src="https://d3js.org/d3-quadtree.v2.min.js"></script>
    <script src="https://d3js.org/d3-timer.v2.min.js"></script>
    <script src="https://d3js.org/d3-force.v2.min.js"></script>
    
    <!-- 6. Load 3D-force-graph which depends on THREE -->
    <script src="https://unpkg.com/3d-force-graph@1.70.5/dist/3d-force-graph.min.js" onload="ensureGlobalTHREE()"></script>
    
    <!-- Add GitHub repo fetcher before network data scripts -->
    <script src="assets/js/github-repo-fetcher.js"></script>
    <script src="assets/js/markdown-parser.js"></script>
    
    <!-- 7. Load baseline data and utilities -->
    <script src="assets/js/network-data.js"></script>
    <script src="assets/js/network-data-generator.js"></script>
    <script src="assets/js/frame-templates.js"></script>
    <script src="assets/js/repository-language-detector.js"></script>
    <script src="assets/js/content-loader.js"></script>
    <script src="assets/js/site-config.js"></script>
    
    <!-- 8. Load our custom graph layout before the graph initialization -->
    <script src="assets/js/graph-layout.js"></script>
    
    <!-- 9. Load camera manager for improved view positioning -->
    <script src="assets/js/camera-manager.js"></script>
    
    <script src="assets/js/react-bridge.js"></script>
    <script src="assets/js/menu-color-manager.js"></script>
    
    <!-- 10. Load dependent modules after THREE and data are available -->
    <script src="assets/js/celestial-bodies.js"></script>
    <script src="assets/js/main.js"></script>
    
    <!-- 11. Finally load the graph initialization -->
    <script src="assets/js/graph.js"></script>
    
    <!-- Initialize app after all scripts are loaded -->
    <script>
        // Ensure all resources are loaded before initialization
        window.addEventListener('load', () => {
            // Start app initialization if not already started
            if (window.initializeApp && typeof window.initializeApp === 'function') {
                window.initializeApp();
            }
        });
    </script>
    
    <!-- 12. Improved React app loading with better fallback mechanism -->
    <script>
        // Flag to track React initialization status
        window.reactInitialized = false;
        
        // Function to handle React load failure
        function handleReactLoadError() {
            console.warn('Failed to load React app script. Falling back to standard content rendering.');
            document.dispatchEvent(new Event('reactLoadFailed'));
            
            // Set flag to prevent duplicate fallback attempts
            window.reactLoadAttempted = true;
        }
    </script>
    
    <!-- Don't try to load React if the build directory doesn't exist -->
    <script>
        // Check if we're in development or production mode
        const isLocalDevelopment = 
            window.location.hostname === 'localhost' || 
            window.location.hostname === '127.0.0.1';
            
        if (!isLocalDevelopment) {
            // Production - load from build directory
            const reactScript = document.createElement('script');
            reactScript.src = 'build/static/js/main.js';
            reactScript.onerror = handleReactLoadError;
            document.body.appendChild(reactScript);
        } else {
            // Development - directly trigger fallback
            setTimeout(function() {
                if (!window.reactInitialized && !window.reactLoadAttempted) {
                    handleReactLoadError();
                }
            }, 500);
        }
        
        // Final fallback check
        setTimeout(function() {
            if (!window.reactInitialized && !window.reactLoadAttempted) {
                console.warn('React did not initialize within the expected time frame, using fallback methods');
                document.dispatchEvent(new Event('reactLoadFailed'));
            }
        }, 3000);
    </script>
</body>
</html>
